<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propuestas de Donantes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; font-size: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; background: white; padding: 30px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { color: #333; font-size: 3rem; margin-bottom: 15px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card-header { margin-bottom: 20px; }
        .card-title { font-size: 2rem; font-weight: bold; margin-bottom: 12px; }
        .card-subtitle { font-size: 1.6rem; color: #666; margin-bottom: 15px; }
        .card-content { margin-bottom: 20px; }
        .card-section { margin-bottom: 18px; }
        .card-label { font-weight: bold; color: #555; font-size: 1.2rem; margin-bottom: 8px; }
        .card-text { color: #333; line-height: 1.5; font-size: 1.1rem; }
        .card-date { text-align: right; color: #888; font-size: 1.1rem; font-style: italic; }
        .footer { text-align: center; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .footer p { font-size: 1.4rem; color: #333; }
        .footer a { color: #007bff; text-decoration: none; font-weight: bold; }
        .footer a:hover { text-decoration: underline; }
        .loading { text-align: center; padding: 60px; color: #666; font-size: 1.6rem; }
        .error { background: #f8d7da; color: #721c24; padding: 25px; border-radius: 8px; margin: 25px 0; text-align: center; font-size: 1.2rem; }
        
        /* Colores pastel para las tarjetas */
        .card:nth-child(6n+1) { background: linear-gradient(135deg, #ffeaa7, #fab1a0); }
        .card:nth-child(6n+2) { background: linear-gradient(135deg, #a8e6cf, #88d8a3); }
        .card:nth-child(6n+3) { background: linear-gradient(135deg, #ffd3e1, #fd79a8); }
        .card:nth-child(6n+4) { background: linear-gradient(135deg, #d1ecf1, #74b9ff); }
        .card:nth-child(6n+5) { background: linear-gradient(135deg, #e8d5ff, #a29bfe); }
        .card:nth-child(6n+6) { background: linear-gradient(135deg, #ffe8d6, #fdcb6e); }
        
        @media (max-width: 768px) {
            .cards-grid { grid-template-columns: 1fr; gap: 20px; }
            .header h1 { font-size: 2.5rem; }
            .card { padding: 25px; }
            .card-title { font-size: 1.8rem; }
            .card-subtitle { font-size: 1.4rem; }
            .card-label { font-size: 1.1rem; }
            .card-text { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Propuestas de Donantes</h1>
        </div>

        <div id="loading" class="loading">Cargando propuestas...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="cardsContainer" class="cards-grid" style="display: none;"></div>

        <div class="footer">
            <p>Si quieres apoyar alguna de las propuestas, <a href="https://n8n.albored.com/form/prop" target="_blank">haz clic aquí</a> y búscala por el nombre de la propuesta.</p>
        </div>
    </div>

    <script>
        function parseValue(value) {
            if (!value || value === '') return '';
            return value.toString().trim();
        }

        function getCSVUrl() {
            return 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTju1yyGhnl921dWPpi_MauKg_H0MBwEBxCR3jnO2NwJv5J8wAmF99jTeSr-YLTYpvfuYlDrisp36RZ/pub?output=csv&gid=1596068065';
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr.trim() === '') return '';
            try {
                // Intentar diferentes formatos de fecha
                let date;
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        // Formato DD/MM/YYYY
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } else {
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) {
                    return dateStr; // Devolver original si no se puede parsear
                }
                
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch {
                return dateStr;
            }
        }

        function createCard(data) {
            const card = document.createElement('div');
            card.className = 'card';
            
            // Formatear aportes con saltos de línea
            const aportesFormatted = parseValue(data['Que puedo aportar']).replace(/\n/g, '<br>');
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${parseValue(data['Nombre'])}</div>
                    <div class="card-subtitle">${parseValue(data['Nombre_de_la_Propuesta'])}</div>
                </div>
                <div class="card-content">
                    <div class="card-section">
                        <div class="card-label">Propuesta:</div>
                        <div class="card-text">${parseValue(data['Propuesta'])}</div>
                    </div>
                    <div class="card-section">
                        <div class="card-label">Se necesita:</div>
                        <div class="card-text">${parseValue(data['Se necesita'])}</div>
                    </div>
                    <div class="card-section">
                        <div class="card-label">Qué puedo aportar:</div>
                        <div class="card-text">${aportesFormatted}</div>
                    </div>
                </div>
                <div class="card-date">${formatDate(data['Fecha'])}</div>
            `;
            
            return card;
        }

        async function loadData() {
            // Comentado para probar datos reales
            // if (window.location.hostname === 'localhost' || window.location.hostname === '0.0.0.0') {
            //     displayCards(sampleData);
            //     return;
            // }
            
            try {
                console.log('Intentando cargar desde:', getCSVUrl());
                const response = await fetch(getCSVUrl());
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV length:', csvText.length);
                console.log('First 200 chars:', csvText.substring(0, 200));
                
                // Parsear CSV correctamente respetando comillas
                function parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                }
                
                const lines = csvText.split('\n');
                const headers = parseCSVLine(lines[0]);
                console.log('Headers:', headers);
                
                const rawData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        if (row['Nombre'] || row['Nombre_de_la_Propuesta']) {
                            rawData.push(row);
                        }
                    }
                }
                
                // Agrupar registros por nombre de propuesta
                const groupedData = {};
                
                rawData.forEach(row => {
                    const propuestaNombre = row['Nombre_de_la_Propuesta'];
                    if (propuestaNombre) {
                        if (!groupedData[propuestaNombre]) {
                            groupedData[propuestaNombre] = {
                                mainRecord: null,
                                contributors: []
                            };
                        }
                        
                        // Si tiene propuesta y se necesita, es el registro principal
                        if (row['Propuesta'] && row['Propuesta'].trim() && row['Se necesita'] && row['Se necesita'].trim()) {
                            groupedData[propuestaNombre].mainRecord = row;
                        } else if (row['Que puedo aportar'] && row['Que puedo aportar'].trim()) {
                            // Es un contribuyente adicional
                            groupedData[propuestaNombre].contributors.push({
                                nombre: row['Nombre'],
                                aporte: row['Que puedo aportar'],
                                fecha: row['Fecha']
                            });
                        }
                    }
                });
                
                // Crear datos finales combinando registro principal con contribuyentes
                const data = [];
                Object.keys(groupedData).forEach(propuestaNombre => {
                    const group = groupedData[propuestaNombre];
                    if (group.mainRecord) {
                        const combinedRecord = { ...group.mainRecord };
                        
                        // Agregar contribuyentes al campo "Que puedo aportar"
                        if (group.contributors.length > 0) {
                            const allAportes = [];
                            if (combinedRecord['Que puedo aportar'] && combinedRecord['Que puedo aportar'].trim()) {
                                allAportes.push(`${combinedRecord['Que puedo aportar']}\n${combinedRecord['Fecha']}`);
                            }
                            allAportes.push('------');
                            group.contributors.forEach(contrib => {
                                allAportes.push(`${contrib.nombre}: ${contrib.aporte}\n${contrib.fecha}`);
                            });
                            combinedRecord['Que puedo aportar'] = allAportes.join('\n\n');
                        }
                        
                        data.push(combinedRecord);
                    }
                });
                
                console.log('Data loaded:', data.length, 'records');
                console.log('Sample record:', data[0]);
                console.log('Grouped data:', data.length, 'records');
                displayCards(data);
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error: ${error.message}. Revisa la consola para más detalles.`;
            }
        }

        function displayCards(data) {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            console.log('Displaying cards for data:', data);
            
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">No hay propuestas disponibles en este momento.<br><br>Debug: Revisa la consola para más detalles.</div>';
            } else {
                data.forEach(item => {
                    const card = createCard(item);
                    container.appendChild(card);
                });
            }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('cardsContainer').style.display = 'grid';
        }

        function checkAccess() {
            const referrer = document.referrer;
            const urlParams = new URLSearchParams(window.location.search);
            
            // Verificar si viene de n8n
            const isFromN8N = referrer.includes('n8n.albored.com') || 
                             urlParams.get('source') === 'n8n' ||
                             sessionStorage.getItem('n8n_access') === 'true';
            
            if (isFromN8N) {
                sessionStorage.setItem('n8n_access', 'true');
                return true;
            }
            
            // Bloquear acceso directo
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: Arial;">
                    <h2>Acceso Restringido</h2>
                    <p>Este dashboard solo puede ser accedido desde el bot de Telegram autorizado.</p>
                </div>
            `;
            return false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (checkAccess()) {
                loadData();
            }
        });

        // Auto-refresh cada 10 minutos
        setInterval(() => {
            if (document.getElementById('cardsContainer').style.display !== 'none') {
                loadData();
            }
        }, 600000);
    </script>
</body>
</html>