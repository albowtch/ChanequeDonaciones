<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaneque Despierta Donaciones</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 15px; font-size: 18px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5rem; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .metric { background: white; padding: 25px 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric h3 { color: #666; font-size: 16px; margin-bottom: 12px; }
        .metric .value { font-size: 28px; font-weight: bold; color: #333; word-break: break-all; }
        .filters { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filter-row { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .filter-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 18px; }
        .filter-group input, .filter-group select { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 20px; }
        .btn { background: #007bff; color: white; border: none; padding: 18px 25px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 15px; font-size: 20px; }
        .btn:hover { background: #0056b3; }
        .content { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .table-container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .main-data { background: #e8f5e8; }
        .secondary-data { background: #fce4ec; margin-top: 20px; padding: 25px; border-top: 2px solid #eee; border-radius: 8px; }
        .chart-container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container h3 { font-size: 1.8rem; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 18px; }
        th, td { padding: 15px 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; font-size: 16px; }
        .table-scroll { overflow-x: auto; }
        .loading { text-align: center; padding: 40px; color: #666; font-size: 20px; }
        .error { background: #f8d7da; color: #721c24; padding: 20px; border-radius: 4px; margin: 20px 0; font-size: 18px; }
        
        /* Tablet */
        @media (min-width: 768px) {
            body { padding: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8rem; }
            .metrics { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .metric { padding: 20px 15px; }
            .metric .value { font-size: 20px; }
            .filter-row { grid-template-columns: repeat(2, 1fr); }
            .content { grid-template-columns: 2fr 1fr; gap: 20px; }
            table { font-size: 15px; }
            th, td { padding: 10px 8px; }
        }
        
        /* Desktop */
        @media (min-width: 1024px) {
            body { padding: 20px; }
            .header h1 { font-size: 2rem; }
            .metrics { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
            .metric { padding: 20px; }
            .metric .value { font-size: 24px; }
            .filter-row { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .btn { width: auto; }
            table { font-size: 16px; }
            th, td { padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chaneque Despierta Donaciones</h1>
        </div>

        <div class="metrics">
            <div class="metric">
                <h3>Existente</h3>
                <div class="value" id="totalExistente">-</div>
            </div>
            <div class="metric">
                <h3>Tot. En Especie</h3>
                <div class="value" id="totalEspecie">-</div>
            </div>
            <div class="metric">
                <h3>Can. Tot.</h3>
                <div class="value" id="cantidadTotal">-</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Buscar por Nombre:</label>
                    <input type="text" id="filterNombre" placeholder="Ingrese nombre...">
                </div>
                <div class="filter-group">
                    <label>Fecha Desde:</label>
                    <input type="date" id="filterFechaDesde">
                </div>
                <div class="filter-group">
                    <label>Fecha Hasta:</label>
                    <input type="date" id="filterFechaHasta">
                </div>

                <div class="filter-group">
                    <button class="btn" onclick="applyFilters()">Filtrar</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="table-container main-data">
                <h3>Datos Principales</h3>
                <div id="loading" class="loading">Cargando datos...</div>
                <div id="error" class="error" style="display: none;"></div>
                <div class="table-scroll">
                    <table id="mainTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Nombre</th>
                                <th>Dinero</th>
                                <th>Especie</th>
                                <th>Cant.</th>
                                <th>Exist.</th>
                            </tr>
                        </thead>
                        <tbody id="mainTableBody"></tbody>
                    </table>
                </div>

                <div class="secondary-data">
                    <h3>Donaciones Usadas</h3>
                    <div class="table-scroll">
                        <table id="secondaryTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Fecha</th>
                                    <th>Especie</th>
                                    <th>Uso</th>
                                    <th>Usada</th>
                                    <th>Disp.</th>
                                    <th>E.Usada</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="secondaryTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Distribución de Fondos</h3>
                <canvas id="pieChart" width="300" height="200"></canvas>
                <h3 style="margin-top: 20px;">Distribución En Especie</h3>
                <canvas id="especieChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let chart = null;

        function parseNumber(value) {
            if (!value || value === '') return 0;
            return parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
        }
        
        function parseValue(value) {
            if (!value || value === '') return '';
            return value.toString().trim();
        }

        async function loadData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTju1yyGhnl921dWPpi_MauKg_H0MBwEBxCR3jnO2NwJv5J8wAmF99jTeSr-YLTYpvfuYlDrisp36RZ/pub?output=csv&gid=1107887473');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                allData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        allData.push(row);
                    }
                }
                
                filteredData = [...allData];
                updateMetrics();
                updateTable();
                updateChart();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainTable').style.display = 'table';
                document.getElementById('secondaryTable').style.display = 'table';
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error al cargar los datos: ' + error.message;
            }
        }

        function updateMetrics() {
            let totalExistente = 0;
            let totalEspecie = 0;
            let cantidadTotal = 0;
            
            filteredData.forEach((row, index) => {
                const existente = parseNumber(row['Existente']);
                const cantidad = parseNumber(row['Cantidad']);
                
                totalExistente += existente;
                cantidadTotal += cantidad;
            });
            
            // Concatenar todos los valores de Tot. En especie
            const especiesArray = [];
            const cantidadesArray = [];
            
            filteredData.forEach(row => {
                const especie = parseValue(row['Tot. En especie']);
                const canTot = parseValue(row['Can.Tot']);
                
                if (especie) especiesArray.push(especie);
                if (canTot) cantidadesArray.push(canTot);
            });
            
            totalEspecie = especiesArray.join('<br>');
            const totalCanTot = cantidadesArray.join('<br>');

            document.getElementById('totalExistente').textContent = '$' + Math.round(totalExistente);
            document.getElementById('totalEspecie').innerHTML = totalEspecie;
            document.getElementById('cantidadTotal').innerHTML = totalCanTot || cantidadTotal.toFixed(0);
        }

        function updateTable() {
            const tbody = document.getElementById('mainTableBody');
            tbody.innerHTML = '';

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                
                const existente = parseNumber(row['Existente']);
                const cantidad = parseNumber(row['Cantidad']);
                const dinero = parseNumber(row['En Dinero']);
                const especie = parseValue(row['En Especie']);
                const existencia = parseNumber(row['Existencia']);
                const cantUsada = parseNumber(row['Cant Usada']);
                const espUsada = parseNumber(row['Esp Usada']);
                const totalEspecieRow = parseNumber(row['Total especie']);
                
                let valorMostrar;
                
                if (dinero > 0) {
                    // Es donación en dinero - mostrar existencia
                    valorMostrar = `$${existencia.toFixed(2)}`;
                } else {
                    // Es donación en especie - mostrar total especie
                    valorMostrar = totalEspecieRow > 0 ? totalEspecieRow.toFixed(0) : '';
                }

                tr.innerHTML = `
                    <td>${row['FechaDona'] || ''}</td>
                    <td>${row['Nombre'] || ''}</td>
                    <td>${row['En Dinero'] || '$0.00'}</td>
                    <td>${especie}</td>
                    <td>${cantidad.toFixed(0)}</td>
                    <td>${valorMostrar}</td>
                `;
                tbody.appendChild(tr);
            });

            updateSecondaryTable();
        }

        function updateSecondaryTable() {
            const tbody = document.getElementById('secondaryTableBody');
            tbody.innerHTML = '';

            filteredData.forEach(row => {
                const cantUsada = parseNumber(row['Cant Usada']);
                const espUsada = parseNumber(row['Esp Usada']);
                
                if (cantUsada > 0 || espUsada > 0) {
                    const tr = document.createElement('tr');
                    const disponible = parseNumber(row['Disponible']);
                    const totalEspecie = parseNumber(row['Total especie']);
                    const enEspecie = parseValue(row['En Especie']);
                    
                    tr.innerHTML = `
                        <td>${row['Nombre'] || ''}</td>
                        <td>${row['FechaUso'] || ''}</td>
                        <td>${enEspecie}</td>
                        <td>${row['Se uso en'] || ''}</td>
                        <td>${cantUsada > 0 ? cantUsada.toFixed(2) : ''}</td>
                        <td>${disponible.toFixed(2)}</td>
                        <td>${espUsada > 0 ? espUsada.toFixed(2) : ''}</td>
                        <td>${totalEspecie.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        function updateChart() {
            const ctx = document.getElementById('pieChart').getContext('2d');
            const ctxEspecie = document.getElementById('especieChart').getContext('2d');
            
            let totalDinero = 0;
            let totalUsado = 0;
            let totalDisponible = 0;
            let totalCantidad = 0;
            let totalEspUsada = 0;

            filteredData.forEach(row => {
                totalDinero += parseNumber(row['En Dinero']);
                totalUsado += parseNumber(row['Cant Usada']);
                totalDisponible += parseNumber(row['Disponible']);
                totalCantidad += parseNumber(row['Cantidad']);
                totalEspUsada += parseNumber(row['Esp Usada']);
            });

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Total en Dinero', 'Total Usado', 'Total Disponible'],
                    datasets: [{
                        data: [totalDinero, totalUsado, totalDisponible],
                        backgroundColor: ['#007bff', '#dc3545', '#28a745'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Gráfico de especie - datos por tipo
            const especieData = {};
            
            filteredData.forEach(row => {
                const nombre = parseValue(row['En Especie']);
                const cantidad = parseNumber(row['Cantidad']);
                const espUsada = parseNumber(row['Esp Usada']);
                const totalEspecie = parseNumber(row['Total especie']);
                
                if (nombre && (cantidad > 0 || espUsada > 0 || totalEspecie > 0)) {
                    if (!especieData[nombre]) {
                        especieData[nombre] = {
                            cantidad: 0,
                            espUsada: 0,
                            totalEspecie: 0
                        };
                    }
                    especieData[nombre].cantidad += cantidad;
                    especieData[nombre].espUsada += espUsada;
                    especieData[nombre].totalEspecie += totalEspecie;
                }
            });
            
            const labels = Object.keys(especieData);
            
            new Chart(ctxEspecie, {
                type: 'doughnut',
                data: {
                    labels: labels.map(label => {
                        const data = especieData[label];
                        return `${label} (${data.cantidad - data.espUsada}/${data.cantidad})`;
                    }),
                    datasets: [{
                        data: labels.map(label => especieData[label].cantidad - especieData[label].espUsada),
                        backgroundColor: [
                            '#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1', 
                            '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function applyFilters() {
            const nombreFilter = document.getElementById('filterNombre').value.toLowerCase();
            const fechaDesde = document.getElementById('filterFechaDesde').value;
            const fechaHasta = document.getElementById('filterFechaHasta').value;


            filteredData = allData.filter(row => {
                if (nombreFilter && !row['Nombre'].toLowerCase().includes(nombreFilter)) {
                    return false;
                }

                if (fechaDesde || fechaHasta) {
                    const fechaDona = new Date(row['FechaDona']);
                    if (fechaDesde && fechaDona < new Date(fechaDesde)) return false;
                    if (fechaHasta && fechaDona > new Date(fechaHasta)) return false;
                }



                return true;
            });

            updateMetrics();
            updateTable();
            updateChart();
        }

        function checkAccess() {
            const referrer = document.referrer;
            const userAgent = navigator.userAgent;
            const urlParams = new URLSearchParams(window.location.search);
            
            // Verificar si viene de n8n
            const isFromN8N = referrer.includes('n8n.albored.com') || 
                             referrer.includes('dashchan') ||
                             urlParams.get('source') === 'n8n' ||
                             sessionStorage.getItem('n8n_access') === 'true';
            
            if (isFromN8N) {
                sessionStorage.setItem('n8n_access', 'true');
                return true;
            }
            
            // Bloquear acceso directo
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: Arial;">
                    <h2>Acceso Restringido</h2>
                    <p>Este dashboard solo puede ser accedido desde el bot de Telegram autorizado.</p>
                </div>
            `;
            return false;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAccess()) {
                loadData();
            }
        });

        setInterval(() => {
            loadData();
        }, 300000);
    </script>
</body>
</html>