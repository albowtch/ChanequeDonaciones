<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaneque Despierta Donaciones</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 15px; font-size: 18px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5rem; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .metric h3 { margin: 0 0 10px 0; color: #666; font-size: 16px; }
        .metric .value { font-size: 24px; font-weight: bold; color: #333; }
        .filters { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filter-row { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .filter-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 18px; }
        .filter-group input, .filter-group select { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 20px; }
        .btn { background: #007bff; color: white; border: none; padding: 18px 25px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 15px; font-size: 20px; }
        .btn:hover { background: #0056b3; }
        .content { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .table-container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .main-data { background: #e8f5e8; }
        .secondary-data { background: #fce4ec; margin-top: 20px; padding: 25px; border-top: 2px solid #eee; border-radius: 8px; }
        .chart-container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container h3 { font-size: 1.8rem; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 18px; }
        th, td { padding: 15px 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; font-size: 16px; }
        .table-scroll { overflow-x: auto; }
        .loading { text-align: center; padding: 40px; color: #666; font-size: 20px; }
        .error { background: #f8d7da; color: #721c24; padding: 20px; border-radius: 4px; margin: 20px 0; font-size: 18px; }
        
        /* Tablet */
        @media (min-width: 768px) {
            body { padding: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8rem; }
            .metrics { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .metric { padding: 20px 15px; }
            .metric .value { font-size: 20px; }
            .filter-row { grid-template-columns: repeat(2, 1fr); }
            .content { grid-template-columns: 2fr 1fr; gap: 20px; }
            table { font-size: 15px; }
            th, td { padding: 10px 8px; }
        }
        
        /* Desktop */
        @media (min-width: 1024px) {
            body { padding: 20px; }
            .header h1 { font-size: 2rem; }
            .metrics { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
            .metric { padding: 20px; }
            .metric .value { font-size: 24px; }
            .filter-row { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .btn { width: auto; }
            table { font-size: 16px; }
            th, td { padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chaneque Despierta Donaciones</h1>
        </div>

        <div class="metrics">
            <div class="metric">
                <h3>Total Dinero</h3>
                <div class="value" id="totalDinero">$0</div>
            </div>
            <div class="metric">
                <h3>Dinero Disponible</h3>
                <div class="value" id="dineroDisponible">$0</div>
            </div>
            <div class="metric">
                <h3>Especies Activas</h3>
                <div class="value" id="especiesActivas">0</div>
            </div>

        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Buscar por Nombre:</label>
                    <input type="text" id="filterNombre" placeholder="Ingrese nombre...">
                </div>
                <div class="filter-group">
                    <label>Fecha Desde:</label>
                    <input type="date" id="filterFechaDesde">
                </div>
                <div class="filter-group">
                    <label>Fecha Hasta:</label>
                    <input type="date" id="filterFechaHasta">
                </div>
                <div class="filter-group">
                    <button class="btn" onclick="applyFilters()">Filtrar</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="table-container main-data">
                <h3>Resumen por Donante</h3>
                <div id="loading" class="loading">Cargando datos...</div>
                <div id="error" class="error" style="display: none;"></div>
                <div class="table-scroll">
                    <table id="mainTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Donante</th>
                                <th>Dinero Donado</th>
                                <th>Dinero Disponible</th>
                                <th>Especies</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody id="mainTableBody"></tbody>
                    </table>
                </div>

                <div class="secondary-data">
                    <h3>Gastos Registrados</h3>
                    <div class="table-scroll">
                        <table id="secondaryTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Donante</th>
                                    <th>Especie</th>
                                    <th>Cantidad</th>
                                    <th>$ Usado</th>
                                    <th>Se uso en</th>
                                </tr>
                            </thead>
                            <tbody id="secondaryTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Distribución de Fondos</h3>
                <canvas id="pieChart" width="300" height="200"></canvas>
                <h3 style="margin-top: 20px;">Distribución En Especie</h3>
                <canvas id="especieChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let chart = null;

        async function loadData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTju1yyGhnl921dWPpi_MauKg_H0MBwEBxCR3jnO2NwJv5J8wAmF99jTeSr-YLTYpvfuYlDrisp36RZ/pub?output=csv&gid=1904984712');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                allData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const cols = lines[i].split(',');
                        allData.push({
                            id: cols[0] || '',
                            timestamp: cols[1] || '',
                            evento: cols[2] || '',
                            donante: cols[3] || '',
                            especie: cols[4] || '',
                            cantidad: parseFloat(cols[5]) || 0,
                            dinero: parseFloat(cols[6]) || 0,
                            uso: cols[7] || ''
                        });
                    }
                }
                
                filteredData = [...allData];
                updateMetrics();
                updateTable();
                updateChart();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainTable').style.display = 'table';
                document.getElementById('secondaryTable').style.display = 'table';
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error al cargar los datos: ' + error.message;
            }
        }

        function updateMetrics() {
            const totalDinero = filteredData
                .filter(e => e.evento === 'INGRESO')
                .reduce((sum, e) => sum + e.dinero, 0);
            
            const dineroUsado = filteredData
                .filter(e => e.evento === 'GASTO')
                .reduce((sum, e) => sum + e.dinero, 0);
            
            const especiesUnicas = Array.from(new Set(
                filteredData
                    .filter(e => e.especie && e.especie.trim() !== '')
                    .map(e => e.especie)
            ));

            document.getElementById('totalDinero').textContent = `$${totalDinero.toFixed(2)}`;
            document.getElementById('dineroDisponible').textContent = `$${(totalDinero - dineroUsado).toFixed(2)}`;
            document.getElementById('especiesActivas').innerHTML = especiesUnicas.length > 0 ? especiesUnicas.join('<br>') : 'Sin especies';

        }

        function updateTable() {
            const resumen = {};
            
            filteredData.forEach(evento => {
                const donante = evento.donante;
                if (!resumen[donante]) {
                    resumen[donante] = {
                        dineroIngreso: 0,
                        dineroGasto: 0,
                        cantidadIngreso: 0,
                        fechaIngreso: '',
                        especies: new Set(),
                        usos: new Set()
                    };
                }
                
                if (evento.evento === 'INGRESO') {
                    resumen[donante].dineroIngreso += evento.dinero;
                    resumen[donante].cantidadIngreso += evento.cantidad;
                    resumen[donante].fechaIngreso = evento.timestamp;
                    if (evento.especie) resumen[donante].especies.add(evento.especie);
                } else if (evento.evento === 'GASTO') {
                    resumen[donante].dineroGasto += evento.dinero;
                    if (evento.uso) resumen[donante].usos.add(evento.uso);
                }
            });
            
            const tbody = document.getElementById('mainTableBody');
            tbody.innerHTML = '';
            
            Object.keys(resumen).forEach(donante => {
                const data = resumen[donante];
                const disponible = data.dineroIngreso - data.dineroGasto;
                
                const tr = document.createElement('tr');
                const fechaFormateada = data.fechaIngreso ? new Date(data.fechaIngreso).toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}) : '';
                
                tr.innerHTML = `
                    <td>${fechaFormateada}</td>
                    <td>${donante}</td>
                    <td>$${data.dineroIngreso.toFixed(2)}</td>
                    <td>$${disponible.toFixed(2)}</td>
                    <td>${Array.from(data.especies).join(', ')}</td>
                    <td>${data.cantidadIngreso}</td>
                `;
                tbody.appendChild(tr);
            });

            updateSecondaryTable();
        }

        function updateSecondaryTable() {
            const tbody = document.getElementById('secondaryTableBody');
            tbody.innerHTML = '';
            
            filteredData
                .filter(evento => evento.evento === 'GASTO')
                .slice().reverse().slice(0, 50)
                .forEach(evento => {
                    const fechaFormateada = evento.timestamp ? new Date(evento.timestamp).toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}) : '';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fechaFormateada}</td>
                        <td>${evento.donante}</td>
                        <td>${evento.especie}</td>
                        <td>${evento.cantidad}</td>
                        <td>$${evento.dinero.toFixed(2)}</td>
                        <td>${evento.uso}</td>
                    `;
                    tbody.appendChild(tr);
                });
        }

        function updateChart() {
            const ctx = document.getElementById('pieChart').getContext('2d');
            const ctxEspecie = document.getElementById('especieChart').getContext('2d');
            
            const totalDinero = filteredData.filter(e => e.evento === 'INGRESO').reduce((sum, e) => sum + e.dinero, 0);
            const totalUsado = filteredData.filter(e => e.evento === 'GASTO').reduce((sum, e) => sum + e.dinero, 0);
            const totalDisponible = totalDinero - totalUsado;

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Total Donado', 'Total Usado', 'Disponible'],
                    datasets: [{
                        data: [totalDinero, totalUsado, totalDisponible],
                        backgroundColor: ['#007bff', '#dc3545', '#28a745'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            const especieData = {};
            filteredData.forEach(evento => {
                if (evento.especie && evento.especie.trim() !== '') {
                    if (!especieData[evento.especie]) {
                        especieData[evento.especie] = { ingreso: 0, gasto: 0 };
                    }
                    if (evento.evento === 'INGRESO') {
                        especieData[evento.especie].ingreso += evento.cantidad;
                    } else if (evento.evento === 'GASTO') {
                        especieData[evento.especie].gasto += evento.cantidad;
                    }
                }
            });
            
            const labels = Object.keys(especieData);
            
            new Chart(ctxEspecie, {
                type: 'doughnut',
                data: {
                    labels: labels.map(label => {
                        const data = especieData[label];
                        const disponible = data.ingreso - data.gasto;
                        return `${label} (${disponible}/${data.ingreso})`;
                    }),
                    datasets: [{
                        data: labels.map(label => {
                            const data = especieData[label];
                            return data.ingreso - data.gasto;
                        }),
                        backgroundColor: [
                            '#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1', 
                            '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function applyFilters() {
            const nombreFilter = document.getElementById('filterNombre').value.toLowerCase();
            const fechaDesde = document.getElementById('filterFechaDesde').value;
            const fechaHasta = document.getElementById('filterFechaHasta').value;

            filteredData = allData.filter(evento => {
                if (nombreFilter && !evento.donante.toLowerCase().includes(nombreFilter)) {
                    return false;
                }

                if (fechaDesde || fechaHasta) {
                    const fechaEvento = new Date(evento.timestamp);
                    if (fechaDesde && fechaEvento < new Date(fechaDesde)) return false;
                    if (fechaHasta && fechaEvento > new Date(fechaHasta)) return false;
                }

                return true;
            });

            updateMetrics();
            updateTable();
            updateChart();
        }

        function checkAccess() {
            const referrer = document.referrer;
            const urlParams = new URLSearchParams(window.location.search);
            
            const isFromN8N = referrer.includes('n8n.albored.com') || 
                             referrer.includes('dashchan') ||
                             urlParams.get('source') === 'n8n' ||
                             sessionStorage.getItem('n8n_access') === 'true';
            
            if (isFromN8N) {
                sessionStorage.setItem('n8n_access', 'true');
                return true;
            }
            
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: Arial;">
                    <h2>Acceso Restringido</h2>
                    <p>Este dashboard solo puede ser accedido desde el bot de Telegram autorizado.</p>
                </div>
            `;
            return false;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAccess()) {
                loadData();
            }
        });

        setInterval(() => {
            loadData();
        }, 300000);
    </script>
</body>
</html>